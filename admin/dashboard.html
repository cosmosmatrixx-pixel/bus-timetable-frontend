<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>

<h2>Admin Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<h3>Upload Buses (CSV)</h3>

<form id="csvUploadForm">
  <input type="file" id="csvFile" accept=".csv" required>
  <button type="submit">Upload</button>
</form>

<p id="uploadStatus"></p>

<hr>

<h3>Uploaded Buses</h3>
<div id="busList">Loading...</div>

<script>
const API = "https://bus-timetable-backend.onrender.com";
const token = localStorage.getItem("adminToken");

if (!token) location.replace("login.html");

/* LOAD BUSES */
function loadBuses() {
  fetch(`${API}/admin/buses`, {
    headers: {
      Authorization: "Bearer " + token
    }
  })
  .then(r => r.json())
  .then(data => {
    if (!data.length) {
      busList.innerHTML = "No buses uploaded";
      return;
    }

    busList.innerHTML = data.map(b => `
      <div style="border:1px solid #ccc; padding:8px; margin:6px 0">
        <b>${b.bus_number}</b><br>
        ${b.route_from} → ${b.route_to}<br>
        ${b.departure_time} – ${b.arrival_time}<br>
        Depot: ${b.depot}
      </div>
    `).join("");
  });
}
loadBuses();

/* CSV UPLOAD */
document.getElementById("csvUploadForm").addEventListener("submit", async e => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("file", csvFile.files[0]);

  uploadStatus.innerText = "Uploading...";

  const res = await fetch(`${API}/admin/import-buses`, {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token
    },
    body: formData
  });

  const data = await res.json();

  if (data.success) {
    uploadStatus.innerText = "Uploaded: " + data.inserted;
    loadBuses();
  } else {
    uploadStatus.innerText = "Upload failed";
  }
});

/* LOGOUT */
function logout() {
  localStorage.removeItem("adminToken");
  location.replace("login.html");
}
</script>

</body>
</html>
