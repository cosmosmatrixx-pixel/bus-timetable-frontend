<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="../style.css">
</head>

<body>
<div class="container">

<div class="dashboard-header">
  <h2>Admin Dashboard</h2>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<h3>Add / Edit Bus Route</h3>

<input id="bus" placeholder="Bus Name">
<br><br>

<textarea id="stations" rows="6" placeholder="Station,Time"></textarea>
<br><br>

<button onclick="addRoute()">Save Route</button>
<p id="msg"></p>

<h3>Change Password</h3>

<input type="password" id="oldPassword" placeholder="Old Password">
<br><br>
<input type="password" id="newPassword" placeholder="New Password">
<br><br>

<button onclick="changePassword()">Change Password</button>
<p id="pwdMsg"></p>

<h3>All Routes</h3>
<div id="routeList"></div>

<script>
const API = "https://bus-timetable-backend.onrender.com";
const token = localStorage.getItem("adminToken");

if (!token) {
  window.location.replace("login.html");
}

/* LOAD ROUTES */
function loadRoutes() {
  fetch(`${API}/admin/routes`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(data => {
    if (!data || data.length === 0) {
      routeList.innerHTML = "<p>No routes found</p>";
      return;
    }

    let html = "<ul>";
    data.forEach(r => {
      html += `
        <li>
          <span class="route-name">${r.bus}</span>
          <div class="route-actions">
            <button onclick="editRoute(${r.id})">Edit</button>
            <button onclick="deleteRoute(${r.id})">Delete</button>
          </div>
        </li>`;
    });
    html += "</ul>";
    routeList.innerHTML = html;
  });
}
loadRoutes();

/* ADD / UPDATE */
function addRoute() {
  const bus = busInput.value.trim();
  const stations = stationsInput.value.split("\n")
    .map(l => l.split(","))
    .filter(p => p.length === 2)
    .map(p => ({ name: p[0], time: p[1] }));

  if (!bus || stations.length < 2) {
    alert("Enter bus name & at least 2 stations");
    return;
  }

  const url = window.currentEditId
    ? `${API}/admin/update-route/${window.currentEditId}`
    : `${API}/admin/add-route`;

  fetch(url, {
    method: window.currentEditId ? "PUT" : "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ bus, stations })
  })
  .then(res => res.json())
  .then(() => {
    busInput.value = "";
    stationsInput.value = "";
    window.currentEditId = undefined;
    loadRoutes();
  });
}

/* DELETE */
function deleteRoute(id) {
  if (!confirm("Delete this route?")) return;

  fetch(`${API}/admin/delete-route/${id}`, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  })
  .then(() => loadRoutes());
}

/* EDIT */
function editRoute(id) {
  fetch(`${API}/admin/route/${id}`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(r => {
    busInput.value = r.bus;
    stationsInput.value = r.stations.map(s => `${s.name},${s.time}`).join("\n");
    window.currentEditId = id;
  });
}

/* CHANGE PASSWORD */
function changePassword() {
  fetch(`${API}/admin/change-password`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({
      oldPassword: oldPassword.value,
      newPassword: newPassword.value
    })
  })
  .then(res => res.json())
  .then(d => {
    pwdMsg.innerText = d.message;
    if (d.message.includes("success")) logout();
  });
}

function logout() {
  localStorage.removeItem("adminToken");
  window.location.replace("login.html");
}

const busInput = document.getElementById("bus");
const stationsInput = document.getElementById("stations");
</script>

</div>
</body>
</html>
