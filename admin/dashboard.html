<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="../style.css">
</head>

<body>
<div class="container">



<div class="dashboard-header">
  <h2>Admin Dashboard</h2>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>


<h3>Add New Bus Route</h3>

<input id="bus" placeholder="Bus Name">
<br><br>

<textarea id="stations" rows="6" cols="40"
placeholder="Station,Time
Panipat,08:00
Karnal,09:00
Ambala,10:30"></textarea>
<br><br>

<button onclick="addRoute()">Add Route</button>



<p id="msg"></p>

<h3>Change Password</h3>

<input type="password" id="oldPassword" placeholder="Old Password">
<br><br>

<input type="password" id="newPassword" placeholder="New Password">
<br><br>

<button onclick="changePassword()">Change Password</button>

<p id="pwdMsg"></p>


<h3>All Routes</h3>
<div id="routeList"></div>




<script>
window.addEventListener("pageshow", function (event) {
  if (event.persisted) {
    window.location.reload();
  }
});
</script>



<!-- üîê TOKEN CHECK -->
<script>
const token = localStorage.getItem("adminToken");

if (!token) {
  alert("Please login first");
  window.location.replace("login.html");
}
</script>




<!-- üì• LOAD ROUTES -->
<script>
function loadRoutes() {
  fetch("https://bus-timetable-backend.onrender.com/admin/routes", {
    headers: {
      Authorization: "Bearer " + token
    }
  })
  .then(res => {
    if (res.status === 401) {
      alert("Session expired. Please login again.");
      localStorage.removeItem("adminToken");
      window.location.href = "login.html";
      return;
    }
    return res.json();
  })
  .then(data => {
    if (!data || data.length === 0) {
      document.getElementById("routeList").innerHTML =
        "<p>No routes found</p>";
      return;
    }

    let html = "<ul>";
    data.forEach(r => {
      html += `
        <li>
    <span class="route-name">${r.bus}</span>

    <div class="route-actions">
      <button onclick="editRoute(${r.id})">Edit</button>
      <button onclick="deleteRoute(${r.id})">Delete</button>
    </div>
  </li>
      `;
    });
    html += "</ul>";
    document.getElementById("routeList").innerHTML = html;
  });
}
loadRoutes();
</script>

<!-- ‚ûï ADD / UPDATE ROUTE -->
<script>
function addRoute() {
  const bus = document.getElementById("bus").value.trim();
  const stationsText = document.getElementById("stations").value;

  const stations = stationsText
    .split("\n")
    .filter(line => line.trim() !== "")
    .map(line => {
      const parts = line.split(",");
      return { name: parts[0], time: parts[1] };
    });

  // ‚úÖ VALIDATION (correct place)
  if (!bus || stations.length < 2) {
    alert("Please enter bus name and at least 2 stations");
    return;
  }

  const isEdit = window.currentEditId !== undefined;
  const url = isEdit
    ? `http://localhost:3000/admin/update-route/${window.currentEditId}`
    : "http://localhost:3000/admin/add-route";

  const method = isEdit ? "PUT" : "POST";

  fetch(url, {
    method: method,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ bus, stations })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);

    document.getElementById("bus").value = "";
    document.getElementById("stations").value = "";
    window.currentEditId = undefined;

    loadRoutes();
  });
}
</script>

<!-- ‚ùå DELETE -->
<script>
function deleteRoute(id) {
  if (!confirm("Are you sure?")) return;

  fetch(`http://localhost:3000/admin/delete-route/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: "Bearer " + token
    }
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    loadRoutes();
  });
}
</script>

<!-- ‚úèÔ∏è EDIT -->
<script>
function editRoute(id) {
  fetch(`http://localhost:3000/admin/route/${id}`, {
    headers: {
      Authorization: "Bearer " + token
    }
  })
  .then(res => res.json())
  .then(route => {
    if (!route) return;

    document.getElementById("bus").value = route.bus;

    let text = "";
    route.stations.forEach(s => {
      text += `${s.name},${s.time}\n`;
    });
    document.getElementById("stations").value = text;

    window.currentEditId = id;
  });
}
</script>

<script>
function changePassword() {
  const oldPassword = document.getElementById("oldPassword").value;
  const newPassword = document.getElementById("newPassword").value;

  if (!oldPassword || !newPassword) {
    alert("Please fill both fields");
    return;
  }

  fetch("http://localhost:3000/admin/change-password", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({
      oldPassword: oldPassword,
      newPassword: newPassword
    })
  })
  .then(res => res.json())
  .then(data => {
     document.getElementById("pwdMsg").innerText = data.message;

  if (data.message.includes("success")) {
    // üîê token delete
    localStorage.removeItem("adminToken");

    alert("Password changed. Please login again.");

    // login page ‡§™‡§∞ ‡§≠‡•á‡§ú‡•ã
    window.location.href = "login.html";
  }
});
}
</script>

<script>
function logout() {
  // üîê Token ‡§π‡§ü‡§æ‡§ì
  localStorage.removeItem("adminToken");

  // Extra safety (cache clear)
  sessionStorage.clear();

  // Login page ‡§™‡§∞ redirect
  window.location.replace("login.html");
}
</script>


</div>
</body>
</html>
